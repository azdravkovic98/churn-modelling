---
title: " Modelovanje ponašanja klijenata u banci"
subtitle: "eng. Churn Modelling"
author:
  - Aleksandra Zdravković
  - Ognjen Lazić
  - Kosta Ljujić
  - Mihajlo Srbakoski
output: 
  pdf_document:
    latex_engine: xelatex
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Uvod


Banke i osiguravajuće kompanije često koriste analizu odliva kupaca (*eng. churn analysis*) i stope odliva klijenata kao jednu od svojih ključnih poslovnih pokazatelja, jer su troškovi zadržavanja postojećih kupaca daleko manji od sticanja novog.

Ova analiza se fokusira na ponašanje bankarskih klijenata za koje je veća verovatnoća da će napustiti banku (tj. zatvoriti svoj bankovni račun). Cilj je otkrivanje najupečatljivijih ponašanja kupaca kroz istraživačku analizu podataka, kao i upotreba tehnika prediktivne analize kako bi se utvrdili kupci koji će najverovatnije napustiti banku.


# Pretprocesiranje podataka (*eng. Data Preprocessing*)

```{r message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(patchwork)
library(caret)
library(vcd)
library(gridExtra)
library(knitr)
library(corrplot)
library(scales)
library(lme4)
library(InformationValue)
library(ROCR)
library(rpart)
library(randomForest)
library(xgboost)
library(MASS)
library(ggmosaic)
library(e1071)
library(ranger)
library(penalized)
library(rpart.plot)
library(ggcorrplot)
library(caTools)
library(RColorBrewer)




library(tibble)
library(corrplot)
library(ggplot2)
library(keras)
library(reticulate)
# in case you run into error run this : reticulate::py_discover_config("keras") 
use_python("C:/Users/azdra/anaconda3/envs/PythonCPU/python.exe")
#use_python("<yourpath>/Anaconda3/envs/r-tensorflow/Scripts/python.exe")
```

```{r}
data <- read.csv("data.csv")
head(data)
glimpse(data)
```

## NA vrednosti

Proverava se da li postoje NA vrednosti:

```{r}
sapply(data, function(x) sum(is.na(x)))
```

Nema nedostajućih vrednosti.

```{r}
summary(data)
```

## Zavisna promenljiva

```{r echo=FALSE, fig.height=3, fig.width=6}
# pomoćni dataframe za koristi vizuelizacije
df <- data.frame(Exited = c(0,1), 
                 Frequency = c(sum(data$Exited == 0), y = c(sum(data$Exited == 1))))
options(repr.plot.width = 10, repr.plot.height = 6)
ggplot(df, aes(x = Exited, y = Frequency, fill = as.factor(Exited))) +
      geom_bar(stat = "identity") +
      theme_minimal() +
      scale_fill_brewer(palette = "Dark2", labels = c("No", "Yes")) +
      labs(fill = "Exited")
```

```{r}
table(data$Exited)
```

Vidi se da većina korisnika nije napustila banku.

## Analiza prediktora

Pogledajmo prvo raspodele neprekidnih prediktora.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=6}
data[, which(names(data) %in% c("Age", 
                                "Balance", 
                                "CreditScore", 
                                "CustomerId"))] %>%
  keep(is.numeric) %>%
  gather() %>%
  ggplot() +
  geom_histogram(mapping = aes(x = value, fill = key), color = "black") +
  facet_wrap(~ key, scales = "free") +
  theme_minimal() +
  theme(legend.position = 'none')
```
Zaključujemo:

* Raspodela prediktora *Age* je pomerena udesno.
* Prediktor *Balance* je blizu normalno raspodeljen.
* Većina predikotra *Credit score* je veća od 600. Moguće je da će baš ovi klijenti napustiti banku.


Pogledajmo sada raspodele kategoričkih prediktora.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=6}
data[, which(names(data) %in% c("Gender", 
                                "Geography", 
                                "HasCrCard", 
                                "IsActiveMember", 
                                "NumOfProducts", 
                                "Tenure"))] %>%
  gather() %>%
  group_by(key, value) %>% 
  summarize(n = n()) %>% 
  ggplot() +
  geom_bar(mapping=aes(x = n, y = value, fill=key), color="black", stat='identity') + 
  coord_flip() +
  facet_wrap(~ key, scales = "free") +
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2") +
  theme(legend.position = 'none')

```

Zaključujemo:

* Veći broj klijenata je muškog pola.
* Klijenti su većinski iz Francuske.
* Većina klijenata ima kreditnu karticu.
* Broj aktivnih i neaktivnih članova je veoma sličan.
* Većina klijenata koristi 1 do 2 proizvoda banke, dok jako malo klijenata koristi 3 i 4 proizvoda.
* Broj klijenata koji su članovi banke $1, 2, ..., 9$ godina je približno isti.



### Prediktor *Age*

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=6}
df <- data %>% 
      dplyr::select(-RowNumber, -CustomerId, -Surname) %>% #remove unwanted column 
      mutate(Geography = as.factor(Geography),
             Gender = as.factor(Gender),
             HasCrCard = as.factor(HasCrCard),
             IsActiveMember = as.factor(IsActiveMember),
             Exited = as.factor(Exited),
             Tenure = as.factor(Tenure),
             NumOfProducts = as.factor(NumOfProducts))

hist <- ggplot(df, aes(x = Age, fill = Exited)) +
              geom_histogram(binwidth = 5) +
              theme_minimal() +
              scale_fill_brewer(palette = "Dark2") +
              scale_x_continuous(breaks = seq(0, 100, by = 10), labels = comma)
boxplot <- ggplot(df, aes(x = Exited, y = Age, fill = Exited)) +
               geom_boxplot() + 
               theme_minimal() +
               scale_fill_brewer(palette = "Dark2") +
               theme(legend.position = 'none')

hist | boxplot
```

Zaključujemo:

* Klijenti koji su ostali u banci imaju tendenciju da budu mlađi.
* Veliki broj kllijenata koji su napustili banku ima između 40 i 50 godina.
* Klijenti starosti između 60 i 80 godina imaju tendenciju da ne napuštaju banku.

### Prediktor *Balance*

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=6}
hist <- ggplot(df, aes(x = Balance, fill = Exited)) +
            geom_histogram() +
            theme_minimal() +
            scale_fill_brewer(palette = "Dark2") +
            theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
            scale_x_continuous(breaks = seq(0, 255000, by = 40000), labels = comma)
boxplot <- ggplot(df, aes(x = Exited, y = Balance, fill = Exited)) +
               geom_boxplot() + 
               theme_minimal() +
               scale_fill_brewer(palette = "Dark2") +
               theme(legend.position = 'none')

hist | boxplot

exp6 <- ggplot(df, aes(Balance, fill = Exited)) + 
        geom_density(alpha = 0.7) + 
        theme_minimal() +
        scale_fill_brewer(palette = "Dark2") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5))


grid.arrange(exp6, boxplot, ncol = 2, nrow = 1)

```

Zaključujemo:

* Klijenti koji ostaju u banci imaju manje sredstava na računu od onih koji napuštaju banku.


### Prediktor *Estimated Salary*

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=6}
hist <- ggplot(df, aes(x = EstimatedSalary, fill = Exited)) +
            geom_histogram() +
            theme_minimal() +
            scale_fill_brewer(palette = "Dark2") +
            theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
boxplot <- ggplot(df, aes(x = Exited, y = EstimatedSalary, fill = Exited)) +
               geom_boxplot() + 
               theme_minimal() +
               scale_fill_brewer(palette = "Dark2") +
               theme(legend.position = 'none')

hist | boxplot


exp6 <- ggplot(df, aes(EstimatedSalary, fill = Exited)) + 
        geom_density(alpha = 0.7) + 
        theme_minimal() +
        scale_fill_brewer(palette = "Dark2") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5))


grid.arrange(exp6, boxplot, ncol = 2, nrow = 1)
```

Zaključujemo:

* Ne postoji vidna razlika u zaradi između klijenata koji napuštaju/ne napuštaju banku.


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=6}
gender_graph <- df %>%
  dplyr::select(Gender, Exited) %>% 
  table(.) %>% 
  as.data.frame() %>% 
  ggplot(.) +
  ggmosaic::geom_mosaic(aes(weight = Freq, x = product(Gender), fill = Exited)) +
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = 'Gender')

geography_graph <- df %>%
  dplyr::select(Geography, Exited) %>% 
  table(.) %>% 
  as.data.frame() %>% 
  ggplot(.) +
  ggmosaic::geom_mosaic(aes(weight = Freq, x = product(Geography), fill = Exited)) +
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = 'Geography')

tenure_graph <- df %>%
  dplyr::select(Tenure, Exited) %>% 
  table(.) %>% 
  as.data.frame() %>% 
  ggplot(.) +
  ggmosaic::geom_mosaic(aes(weight = Freq, x = product(Tenure), fill = Exited)) +
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = 'Tenure')

HasCrCard_graph <- df %>%
  dplyr::select(HasCrCard, Exited) %>% 
  table(.) %>% 
  as.data.frame() %>% 
  ggplot(.) +
  ggmosaic::geom_mosaic(aes(weight = Freq, x = product(HasCrCard), fill = Exited)) +
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = 'HasCrCard')

IsActiveMember_graph <- df %>%
  dplyr::select(IsActiveMember, Exited) %>% 
  table(.) %>% 
  as.data.frame() %>% 
  ggplot(.) +
  ggmosaic::geom_mosaic(aes(weight = Freq, x = product(IsActiveMember), fill = Exited)) +
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = 'IsActiveMember')

NumOfProducts_graph <- df %>%
  dplyr::select(NumOfProducts, Exited) %>% 
  table(.) %>% 
  as.data.frame() %>% 
  ggplot(.) +
  ggmosaic::geom_mosaic(aes(weight = Freq, x = product(NumOfProducts), fill = Exited)) +
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = 'NumOfProducts')
  

(gender_graph | geography_graph) / (IsActiveMember_graph | HasCrCard_graph ) / (tenure_graph | NumOfProducts_graph)
```


## Čišćenje podataka (*eng. Data Cleaning*)

Kako smatramo da *RowNumber, CustomedId, Surname* nisu značajni prediktori, nećemo ih posmatrati u daljem radu.
Kategorički prediktor *Geography* ćemo prebaciti u *dummy varijablu*, dok ćemo *Gender* kodirati binarno.

```{r}
# odbacujemo navedene kolone
data <- data[, -which(names(data) %in% c("RowNumber", "CustomerId", "Surname"))]

# kolona Geography u dummy
data <- fastDummies::dummy_cols(data)

# odbacujemo Geography_Spain i Gender_Male, kako su zavisne od ostalih, kao i 
# Geography i Gender
data <- data[, -which(names(data) %in% c("Geography_Spain", 
                                         "Gender_Male",
                                         "Geography",
                                         "Gender"))]
```


## Korelacija

```{r}
corrplot(cor(data), method = "color")
corrplot(cor(data), order = "hclust",
         col = brewer.pal(n = 8, name = "PuOr"))
```


# Kreiranje modela

```{r}
index_train <- sample(nrow(data), 0.8 * nrow(data))
train <- data[index_train, ]
test <- data[-index_train, ]
```

